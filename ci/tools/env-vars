#!/usr/bin/env bash

# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0

# A utility script to set up the GitHub environment variables for the CI.

set -euo pipefail

# Check if the script was called with exactly 1 argument
if [[ ${#} -ne 1 ]]; then
  echo "Error: This script requires exactly 1 argument (the build mode). You provided ${#}"
  echo "Usage: ${0} build_mode[build or test]"
  exit 1
fi

PYTHON_VERSION_FORMATTED=$(echo "${PY_VER}" | tr -d '.')

if [[ "${HOST_PLATFORM}" == linux* ]]; then
  REPO_DIR=$(pwd)
  TOOLS_PATH="${REPO_DIR}/ci/tools"
elif [[ "${HOST_PLATFORM}" == win* ]]; then
  PWD=$(pwd)
  REPO_DIR=$(cygpath -w ${PWD})
  TOOLS_PATH=$(cygpath -w ${PWD}/ci/tools)
fi

echo "${TOOLS_PATH}" >> $GITHUB_PATH
{
  echo "PYTHON_VERSION_FORMATTED=${PYTHON_VERSION_FORMATTED}"
} >> $GITHUB_ENV

if [[ "${1}" == "build" ]]; then
  # platform is handled by the default value of platform (`auto`) in cibuildwheel
  # here we only need to specify the python version we want
  echo "CIBW_BUILD=cp${PYTHON_VERSION_FORMATTED}-*" >> $GITHUB_ENV
  NUMBA_CUDA_ARTIFACT_BASENAME="numba-cuda-python${PYTHON_VERSION_FORMATTED}-${HOST_PLATFORM}"
  # Enforce an explicit cache dir so that we can reuse this path later
  echo "SCCACHE_DIR=${HOME}/.cache/sccache" >> $GITHUB_ENV
  echo "SCCACHE_CACHE_SIZE=1G" >> $GITHUB_ENV
elif [[ "${1}" == "test" ]]; then
  TEST_CUDA_MAJOR="$(cut -d '.' -f 1 <<< ${CUDA_VER})"
  TEST_CUDA_MINOR="$(cut -d '.' -f 2 <<< ${CUDA_VER})"
  NUMBA_CUDA_ARTIFACT_BASENAME="numba-cuda-python${PYTHON_VERSION_FORMATTED}-${HOST_PLATFORM}"
#  # We don't test compute-sanitizer on CTK<12 because backporting fixes is too much effort
#  # We only test compute-sanitizer on python 3.12 arbitrarily; we don't need to use sanitizer on the entire matrix
#  # Only local ctk installs have compute-sanitizer; there is no wheel for it
#  if [[ "${PY_VER}" == "3.12" && "${CUDA_VER}" != "11.8.0" && "${LOCAL_CTK}" == 1 && "${HOST_PLATFORM}" == linux* ]]; then
#    echo "LATEST_CUDA_VERSION=$(bash .github/workflows/guess_latest.sh $TEST_CUDA_MAJOR)" >> $GITHUB_ENV
#    SETUP_SANITIZER=1
#  else
#    SETUP_SANITIZER=0
#    echo "SANITIZER_CMD=" >> $GITHUB_ENV
#  fi
  {
#    echo "SETUP_SANITIZER=${SETUP_SANITIZER}"
#    echo "SKIP_NUMBA_CUDA_TEST=${SKIP_NUMBA_CUDA_TEST}"
    echo "SANITIZER_CMD="
    echo "TEST_CUDA_MAJOR=${TEST_CUDA_MAJOR}"
    echo "TEST_CUDA_MINOR=${TEST_CUDA_MINOR}"
  } >> $GITHUB_ENV
fi

{
  echo "NUMBA_CUDA_ARTIFACT_BASENAME=${NUMBA_CUDA_ARTIFACT_BASENAME}"
  echo "NUMBA_CUDA_ARTIFACT_NAME=${NUMBA_CUDA_ARTIFACT_BASENAME}-${SHA}"
  echo "NUMBA_CUDA_TEST_ARTIFACT_NAME=numba-cuda-${HOST_PLATFORM}-${SHA}-test"
  echo "NUMBA_CUDA_ARTIFACTS_DIR=$(realpath "${REPO_DIR}/dist")"
} >> $GITHUB_ENV
