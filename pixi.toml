# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: BSD-2-Clause
[workspace]
channels = ["conda-forge"]
platforms = ["linux-64", "linux-aarch64", "win-64"]

[pypi-dependencies]
numba-cuda = { path = ".", editable = true }

[dependencies]
cuda-compiler = "*"
make = "*"
cxx-compiler = "*"
numba = ">=0.60.0"
cuda-bindings = ">=12.9.1,<14"
cuda-core = ">=0.3,<0.4.0dev0"
python = ">=3.9,<3.14"

[feature.cu12.system-requirements]
cuda = "12"

[feature.cu12.dependencies]
cuda-python = "12.9.*"
cuda-nvcc = "12.*"
cuda-nvvm = "12.*"
cuda-runtime = "12.*"
cuda-nvrtc = "*"
libnvjitlink = "12.*"
cuda-cccl = "12.*"
libcurand = "*"

[feature.cu13.system-requirements]
cuda = "13"

[feature.cu13.dependencies]
cuda-python = "13.*"
cuda-nvvm = "13.*"
cuda-runtime = "13.*"
cuda-nvrtc = "*"
libnvjitlink = "13.*"
cuda-cccl = "13.*"
libcurand = "10.4.*"

[feature.bench.dependencies]
pytorch = ">=2.8"
pytorch-gpu = ">=2.8"
libtorch = ">=2.8"
cupy = "*"

[feature.test.dependencies]
pre-commit = "*"
psutil = "*"
cffi = "*"
pytest = "*"
pytest-xdist = "*"
pytest-benchmark = "*"

[feature.test.pypi-dependencies]
ml_dtypes = "*"
filecheck = "*"

[environments]
cu12 = { features = ["cu12", "test", "bench"], solve-group = "cu12" }
cu13 = { features = ["cu13", "test"], solve-group = "cu13" }

[target.linux.tasks]
build-tests = { cmd = [
    "make",
    "-j",
    "$(nproc)",
    "-C",
    "$PIXI_PROJECT_ROOT/testing",
] }
clean-tests = { cmd = [
    "make",
    "-j",
    "$(nproc)",
    "-C",
    "$PIXI_PROJECT_ROOT/testing",
    "clean",
] }
bench = { cmd = [
    "pytest",
    "$PIXI_PROJECT_ROOT/testing",
    "--pyargs",
    "numba.cuda.tests.benchmarks",
    "--benchmark-only",
    "--benchmark-enable",
    "--benchmark-autosave",
    "--benchmark-group-by=func",
] }
benchcmp = { cmd = [
    "pytest",
    "$PIXI_PROJECT_ROOT/testing",
    "--pyargs",
    "numba.cuda.tests.benchmarks",
    "--benchmark-only",
    "--benchmark-enable",
    "--benchmark-group-by=name",
    "--benchmark-compare",
] }

[target.linux.tasks.test]
cmd = ["pytest", "$PIXI_PROJECT_ROOT/testing"]
env = { NUMBA_CUDA_TEST_BIN_DIR = "$PIXI_PROJECT_ROOT/testing" }
depends-on = [{ task = "build-tests" }]

[target.linux.tasks.simtest]
cmd = ["pytest", "$PIXI_PROJECT_ROOT/testing"]
depends-on = [{ task = "build-tests" }]

[target.linux.tasks.simtest.env]
NUMBA_CUDA_TEST_BIN_DIR = "$PIXI_PROJECT_ROOT/testing"
NUMBA_ENABLE_CUDASIM = "1"
